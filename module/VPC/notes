1. create VPC
2. peer connection between default VPC to custom VPC(road)
3. create a Route table (traffic between default VPC and custom VPC)
4. create route table for frontend,backend ,mysql and public subnets
4. Add routes both sides(default vpc for custom vpc and viceversa)
5. create subnets (frontend,backend,mysql,public)
6.create two nat gateways
7.create internet gateway
8. add route internet gateway to public servers
9. add route "nat gateway to frontend servers
10. associate subnets with route table id (frontend,backend,mysql and public)
11. create application load balancer
12. create target group
13. create listeners



resource "aws_subnet" "frontend_subnets" {
  count       = length(var.frontendServers)
  vpc_id      = aws_vpc.vpc.id
  cidr_block  = var.frontendServers[count.index]
  availability_zone = var.availability_zone[count.index]
  tags = {
    Name = "${var.env}-frontend-${count.index+1}"
  }
}

#  create Route table for frontend
resource "aws_route_table" "frontend" {
  count   = length(var.frontendServers)
  vpc_id = aws_vpc.vpc.id
  tags = {
    Name = "${var.env}-frontend-route-${count.index+1}"
  }
}

#  add default vpc cidr block to route_table
resource "aws_route" "frontend_route" {
  count                     = length(var.frontendServers)
  route_table_id            = aws_route_table.frontend[count.index].id
  destination_cidr_block    = var.default_vpc_cidr_block
  vpc_peering_connection_id = aws_vpc_peering_connection.peer.id
}

#  associate frontend subnets with nat
resource "aws_route" "frontend_nat" {
  count                     = length(var.frontendServers)
  route_table_id            = aws_route_table.frontend[count.index].id
  destination_cidr_block    = "0.0.0.0/0"
  nat_gateway_id            = aws_nat_gateway.nat[count.index].id
}

#  associate subnets with route table id
resource "aws_route_table_association" "frontend" {
  count          = length(var.frontendServers)
  subnet_id      = aws_subnet.frontend_subnets[count.index].id
  route_table_id = aws_route_table.frontend[count.index].id
}